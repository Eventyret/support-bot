name: ðŸš€ Complete Deployment Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'prod'
        type: choice
        options:
          - prod
          - dev

permissions:
  contents: read
  id-token: write
  actions: write

jobs:
  # First run the infrastructure deployment
  infrastructure:
    name: Deploy Infrastructure
    uses: ./.github/workflows/terraform-apply.yml
    secrets: inherit
    with:
      environment: ${{ github.event.inputs.environment || 'prod' }}
  
  # Then deploy the backend
  backend:
    name: Deploy Backend
    needs: infrastructure
    uses: ./.github/workflows/backend-deploy.yml
    secrets: inherit
  
  # Finally deploy the frontend
  frontend:
    name: Deploy Frontend
    needs: backend
    uses: ./.github/workflows/frontend-deploy.yml
    secrets: inherit
  
  # Final summary job
  summary:
    name: Deployment Summary
    needs: [infrastructure, backend, frontend]
    runs-on: ubuntu-latest
    steps:
      - name: Deployment Summary
        run: |
          echo "âœ… Infrastructure deployment completed"
          echo "âœ… Backend deployment completed"
          echo "âœ… Frontend deployment completed"
          echo "ðŸŽ‰ Full deployment pipeline complete!" 