name: ðŸš€ Complete Deployment Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'prod'
        type: choice
        options:
          - prod
          - dev

permissions:
  contents: read
  id-token: write
  actions: write

jobs:
  # First run the infrastructure deployment
  infrastructure:
    name: Deploy Infrastructure
    uses: ./.github/workflows/terraform-apply.yml
    secrets: inherit
    with:
      environment: ${{ github.event.inputs.environment || 'prod' }}
  
  # Then deploy the backend
  backend:
    name: Deploy Backend
    needs: infrastructure
    uses: ./.github/workflows/backend-deploy.yml
    secrets: inherit
  
  # Finally deploy the frontend
  frontend:
    name: Deploy Frontend
    needs: backend
    uses: ./.github/workflows/frontend-deploy.yml
    secrets: inherit
  
  # Final summary job
  summary:
    name: Deployment Summary
    needs: [infrastructure, backend, frontend]
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-west-2
          
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_wrapper: false
          
      - name: Get deployment URLs
        working-directory: ./infra
        run: |
          # Store Terraform outputs in environment variables
          BACKEND_URL=$(terraform output -raw alb_dns_name 2>/dev/null || echo "Not available")
          FRONTEND_URL=$(terraform output -raw frontend_website_endpoint 2>/dev/null || echo "Not available")
          
          # Save to GitHub env
          echo "BACKEND_URL=${BACKEND_URL}" >> $GITHUB_ENV
          echo "FRONTEND_URL=${FRONTEND_URL}" >> $GITHUB_ENV
        
      - name: Deployment Summary
        run: |
          echo "âœ… Infrastructure deployment completed"
          echo "âœ… Backend deployment completed"
          echo "âœ… Frontend deployment completed"
          echo "ðŸŽ‰ Full deployment pipeline complete!"
          echo ""
          echo "ðŸ“± Frontend URL: http://${{ env.FRONTEND_URL }}"
          echo "ðŸ”Œ Backend URL: http://${{ env.BACKEND_URL }}"
          echo ""
          echo "Note: It may take a few minutes for DNS to propagate and services to be fully available." 